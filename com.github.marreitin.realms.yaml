app-id: com.github.marreitin.realms
runtime: org.gnome.Platform
runtime-version: "47"
sdk: org.gnome.Sdk
command: realms
tags:
  - devel
  - development
  - nightly
finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --socket=pcsc
  - --device=all
  - --device=dri
  - --filesystem=home
  - --filesystem=/run/libvirt
  - --filesystem=xdg-run/libvirt
  - --filesystem=/var/lib/libvirt
modules:
  - name: realms
    buildsystem: meson
    sources:
      - type: dir
        path: .
    modules:
      - name: libvirt
        buildsystem: meson
        build-options:
          cflags: -I/app/include/tirpc
        config-opts:
          - --libexec=/app/lib/libvirt
          - --sbindir=/app/bin
          - --localstatedir=/var
          - -Drunstatedir=/run
          - -Drpath=enabled
          - -Dqemu_user=kvm
          - -Dqemu_group=kvm
          - -Ddocs=enabled
          - -Dtests=disabled
          - -Dstorage_mpath=disabled
          - -Dfirewalld=disabled
          - -Dinit_script=none
          - -Dsysctl_config=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/libvirt-11.0.0.tar.xz
            sha256: 01a176ff4042ad58cf83c09fe0925d6bc8eed0ecce1e0ee19b8ef4c1ffa3806e
        cleanup:
          - /etc/logrotate.d
          - /share/doc
        modules:
          - name: libnl
            config-opts:
              - --enable-cli=no
              - --disable-static
            sources:
              - type: archive
                url: https://github.com/thom311/libnl/releases/download/libnl3_11_0/libnl-3.11.0.tar.gz
                sha256: 2a56e1edefa3e68a7c00879496736fdbf62fc94ed3232c0baba127ecfa76874d
            cleanup:
              - /etc
              - /share/man

          - name: libtirpc
            config-opts:
              - --disable-gssapi
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-1.3.6.tar.bz2
                sha256: bbd26a8f0df5690a62a47f6aa30f797f3ef8d02560d1bc449a83066b5a1d3508

          - name: python-docutils
            buildsystem: simple
            build-commands:
              - python3 setup.py build
              - python3 setup.py install --root=/ --prefix=app/
            sources:
              - type: archive
                url: http://downloads.sourceforge.net/docutils/docutils-0.18.1.tar.gz
                sha256: 679987caf361a7539d76e584cbeddc311e3aee937877c87346f31debc63e9d06
            cleanup:
              - "*"

          - name: rpcsvc-proto
            sources:
              - type: archive
                url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.3/rpcsvc-proto-1.4.3.tar.gz
                sha256: 6906e0f81bb016bd0216460fc879d3d9f2f6d743be7dfb0d8b32d140226d5ef8
              - type: shell
                commands:
                  - autoreconf -ifv
            cleanup:
              - "*"

      - name: libvirt-glib
        buildsystem: meson
        config-opts:
          - -Drpath=enabled
          - -Ddocs=disabled
          - -Dtests=disabled
          - -Dintrospection=enabled
          - -Dvapi=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/glib/libvirt-glib-5.0.0.tar.xz
            sha256: 9bfec346382416a3575d87299bc641b2a464aa519fd9b1287e318aa43a2f3b8b
        cleanup:
          - /share/gtk-doc
        modules:
          - name: libcap-ng
            config-opts:
              - --enable-static=no
            sources:
              - type: archive
                url: https://github.com/stevegrubb/libcap-ng/archive/v0.8.3.tar.gz
                sha256: e542e9139961f0915ab5878427890cdc7762949fbe216bd0cb4ceedb309bb854
            cleanup:
              - /bin
              - /share/aclocal

      - name: libvirt-python
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "libvirt-python" --no-build-isolation
        sources:
          - type: file
            url: https://libvirt.org/sources/python/libvirt-python-11.0.0.tar.gz
            sha256: cee825a53c6438c5bc84b4250b35493a8e504d5d8075d3d2069ffaf7090846f8

      - name: python-gobject
        buildsystem: meson
        config-opts:
          - -Dpycairo=enabled
        build-options:
          build-args:
            - --share=network
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/pygobject/-/archive/3.51.0/pygobject-3.51.0.tar
            sha256: 469a26fa572724315d57df3dfc030bd16aea0476ef795537e2851ebdebfab0c5
        modules:
          - name: python-cairo
            buildsystem: meson
            sources:
              - type: archive
                url: https://github.com/pygobject/pycairo/releases/download/v1.27.0/pycairo-1.27.0.tar.gz
                sha256: 5cb21e7a00a2afcafea7f14390235be33497a2cce53a98a19389492a60628430

      - name: gtksourceview5
        buildsystem: meson
        config-opts:
          - -Dvapi=false
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/gtksourceview/-/archive/5.14.0/gtksourceview-5.14.0.tar
            sha256: a6981a77bfb58c4b32d7ed2621875b220f076fcd3154ea11330371775b281a30

      - name: python3-yaml
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pyyaml" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/54/ed/79a089b6be93607fa5cdaedf301d7dfb23af5f25c398d5ead2525b063e17/pyyaml-6.0.2.tar.gz
            sha256: d584d9ec91ad65861cc08d42e834324ef890a082e591037abe114850ff7bbc3e

      - name: python3-jinja2
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "jinja2" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/b2/97/5d42485e71dfc078108a86d6de8fa46db44a1a9295e89c5d6d4a06e23a62/markupsafe-3.0.2.tar.gz
            sha256: ee55d3edf80167e48ea11a923c7386f4669df67d7994554387f84e7d8b0a2bf0
          - type: file
            url: https://files.pythonhosted.org/packages/bd/0f/2ba5fbcd631e3e88689309dbe978c5769e883e4b84ebfe7da30b43275c5a/jinja2-3.1.5-py3-none-any.whl
            sha256: aba0f4dc9ed8013c424088f68a5c226f7d6097ed89b246d7749c2ec4175c6adb

      - name: virt-viewer
        buildsystem: meson
        post-install:
          - mv "${FLATPAK_DEST}/share/mime/packages/virt-viewer-mime.xml" "${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml"
        sources:
          - type: git
            url: https://gitlab.com/virt-viewer/virt-viewer
            commit: b6436a552a434bd6c5962af3302846058a1e57c3
        modules:
          - name: lz4
            build-options:
              env:
                PREFIX: /app
            buildsystem: simple
            build-commands:
              - make -j $FLATPAK_BUILDER_N_JOBS
              - make install
            cleanup:
              - /bin
            sources:
              - type: archive
                url: https://github.com/lz4/lz4/archive/refs/tags/v1.10.0.tar.gz
                sha256: 537512904744b35e232912055ccf8ec66d768639ff3abe5788d90d792ec5f48b

          - name: gtk-vnc
            buildsystem: meson
            cleanup:
              - /bin
            sources:
              - type: archive
                url: https://download.gnome.org/sources/gtk-vnc/1.3/gtk-vnc-1.3.1.tar.xz
                sha256: 512763ac4e0559d0158b6682ca5dd1a3bd633f082f5e4349d7158e6b5f80f1ce

          - name: spice-gtk
            buildsystem: meson
            build-options:
              env:
                PYTHONPATH: /app
            config-opts:
              - "-Dvapi=enabled"
              - "-Dwebdav=enabled"
              - "-Dgtk_doc=disabled"
              - "-Dusbredir=enabled"
              - "-Dlibcap-ng=enabled"
              - "-Dpolkit=disabled"
              - "-Degl=enabled"
            sources:
              - type: archive
                url: >-
                  https://gitlab.freedesktop.org/spice/spice-gtk/uploads/e41347144c5d2f9947e215c894969f0e/spice-gtk-0.42.tar.xz
                sha256: 9380117f1811ad1faa1812cb6602479b6290d4a0d8cc442d44427f7f6c0e7a58
            modules:
              - name: phodav
                buildsystem: meson
                config-opts:
                  - -Dsystemdsystemunitdir=lib/systemd/system
                  - -Dudevrulesdir=usr/lib/udev/rules.d
                sources:
                  - type: archive
                    url: https://download.gnome.org/sources/phodav/3.0/phodav-3.0.tar.xz
                    sha256: 392ec2d06d50300dcff1ef269a2a985304e29bce3520002fca29f2edc1d138d1

              - name: libcacard
                sources:
                  - type: archive
                    url: >-
                      https://www.spice-space.org/download/libcacard/libcacard-2.8.1.tar.xz
                    sha256: fbbf4de8cb7db5bdff5ecb672ff0dbe6939fb9f344b900d51ba6295329a332e7

              - name: python-pyparsing
                buildsystem: simple
                build-commands:
                  - pip3 install --prefix=/app pyparsing-3.1.4-py3-none-any.whl
                sources:
                  - type: file
                    url: >-
                      https://files.pythonhosted.org/packages/e5/0c/0e3c05b1c87bb6a1c76d281b0f35e78d2d80ac91b5f8f524cebf77f51049/pyparsing-3.1.4-py3-none-any.whl
                    sha256: a6a7ee4235a3f944aa1fa2249307708f893fe5717dc603503c6c7969c070fb7c

              - name: libusb
                config-opts:
                  - --disable-static
                  - --disable-udev
                cleanup:
                  - /lib/*.la
                  - /lib/pkgconfig
                  - /include
                sources:
                  - type: archive
                    url: https://github.com/libusb/libusb/releases/download/v1.0.27/libusb-1.0.27.tar.bz2
                    sha256: ffaa41d741a8a3bee244ac8e54a72ea05bf2879663c098c82fc5757853441575
                post-install:
                  - install -Dm644 COPYING ${FLATPAK_DEST}/share/licenses/libusb/COPYING

              - name: usbredir
                buildsystem: meson
                config-opts:
                  - -Dtools=disabled
                sources:
                  - type: archive
                    url: https://spice-space.org/download/usbredir/usbredir-0.15.0.tar.xz
                    sha256: 6dc2a380277688a068191245dac2ab7063a552999d8ac3ad8e841c10ff050961

              - name: usbutils
                buildsystem: meson
                sources:
                  - type: archive
                    url: https://www.kernel.org/pub/linux/utils/usb/usbutils/usbutils-018.tar.xz
                    sha256: 83f68b59b58547589c00266e82671864627593ab4362d8c807f50eea923cad93
                modules:
                  - name: hwids
                    buildsystem: simple
                    build-commands:
                      - for ids in pci.ids usb.ids; do install -Dm644 "$ids" /app/share/hwdata/${ids};
                        done
                    sources:
                      - type: archive
                        url: https://github.com/gentoo/hwids/archive/hwids-20210613.tar.gz
                        sha256: e28f1787290e9ea17426aa4090bbf6aca9bbc9e6cd14da232778bfaef4938bc1

              - name: spice-protocol
                buildsystem: meson
                sources:
                  - type: archive
                    url: >-
                      https://www.spice-space.org/download/releases/spice-protocol-0.14.4.tar.xz
                    sha256: 04ffba610d9fd441cfc47dfaa135d70096e60b1046d2119d8db2f8ea0d17d912
