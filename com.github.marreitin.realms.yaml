app-id: com.github.marreitin.realms
runtime: org.gnome.Platform
runtime-version: "47"
sdk: org.gnome.Sdk
command: realms
tags:
    - devel
    - development
    - nightly
finish-args:
    - --share=ipc
    - --socket=fallback-x11
    - --socket=x11
    - --socket=wayland
    - --socket=pulseaudio
    - --share=network
    - --device=all
    - --system-talk-name=org.freedesktop.timedate1
    - --filesystem=home
    - --filesystem=/run/libvirt
modules:
  - name: realms
    buildsystem: meson
    sources:
      - type: dir
        path: .
    modules:
      - name: libvirt
        buildsystem: meson
        build-options:
          cflags: -I/app/include/tirpc
        config-opts:
          - --libexec=/app/lib/libvirt
          - --sbindir=/app/bin
          - --localstatedir=/var
          - -Drunstatedir=/run
          - -Drpath=enabled
          - -Dqemu_user=kvm
          - -Dqemu_group=kvm
          - -Ddocs=enabled
          - -Dtests=disabled
          - -Dstorage_mpath=disabled
          - -Dfirewalld=disabled
          - -Dinit_script=none
          - -Dsysctl_config=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/libvirt-11.0.0.tar.xz
            sha256: 01a176ff4042ad58cf83c09fe0925d6bc8eed0ecce1e0ee19b8ef4c1ffa3806e
        cleanup:
          - /etc/logrotate.d
          - /share/doc
        modules:
          - name: libnl
            config-opts:
              - --enable-cli=no
              - --disable-static
            sources:
              - type: archive
                url: https://github.com/thom311/libnl/releases/download/libnl3_6_0/libnl-3.6.0.tar.gz
                sha256: 532155fd011e5a805bd67121b87a01c757e2bb24112ac17e69cb86013b970009
                x-checker-data:
                  type: json
                  url: https://api.github.com/repos/thom311/libnl/releases/latest
                  version-query: .tag_name | ( sub("^libnl"; "") | gsub("_"; ".") )
                  url-query: .assets[] | select(.name=="libnl-" + $version + ".tar.gz") |
                    .browser_download_url
            cleanup:
              - /etc
              - /share/man
          - name: libtirpc
            config-opts:
              - --disable-gssapi
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-1.3.2.tar.bz2
                sha256: e24eb88b8ce7db3b7ca6eb80115dd1284abc5ec32a8deccfed2224fc2532b9fd
                x-checker-data:
                  type: anitya
                  project-id: 1740
                  stable-only: true
                  url-template: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-$version.tar.bz2
          - name: python-docutils
            buildsystem: simple
            build-commands:
              - python3 setup.py build
              - python3 setup.py install --root=/ --prefix=app/
            sources:
              - type: archive
                url: http://downloads.sourceforge.net/docutils/docutils-0.18.1.tar.gz
                sha256: 679987caf361a7539d76e584cbeddc311e3aee937877c87346f31debc63e9d06
                x-checker-data:
                  type: anitya
                  project-id: 3849
                  stable-only: true
                  url-template: http://downloads.sourceforge.net/docutils/docutils-$version.tar.gz
            cleanup:
              - '*'
          - name: rpcsvc-proto
            sources:
              - type: archive
                url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.3/rpcsvc-proto-1.4.3.tar.gz
                sha256: 6906e0f81bb016bd0216460fc879d3d9f2f6d743be7dfb0d8b32d140226d5ef8
                x-checker-data:
                  type: anitya
                  project-id: 155452
                  stable-only: true
                  url-template: https://github.com/thkukuk/rpcsvc-proto/archive/v$version/rpcsvc-proto-$version.tar.gz
              - type: shell
                commands:
                  - autoreconf -ifv
            cleanup:
              - '*'

      - name: libvirt-glib
        buildsystem: meson
        config-opts:
          - -Drpath=enabled
          - -Ddocs=disabled
          - -Dtests=disabled
          - -Dintrospection=enabled
          - -Dvapi=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/glib/libvirt-glib-5.0.0.tar.xz
            sha256: 9bfec346382416a3575d87299bc641b2a464aa519fd9b1287e318aa43a2f3b8b
            x-checker-data:
              type: anitya
              project-id: 11560
              stable-only: true
              url-template: https://libvirt.org/sources/glib/libvirt-glib-$version.tar.xz
        cleanup:
          - /share/gtk-doc
        modules:
          - name: libcap-ng
            config-opts:
              - --enable-static=no
            sources:
              - type: archive
                url: https://github.com/stevegrubb/libcap-ng/archive/v0.8.3.tar.gz
                sha256: e542e9139961f0915ab5878427890cdc7762949fbe216bd0cb4ceedb309bb854
                x-checker-data:
                  type: anitya
                  project-id: 1570
                  stable-only: true
                  url-template: https://github.com/stevegrubb/libcap-ng/archive/v$version.tar.gz
            cleanup:
              - /bin
              - /share/aclocal

      - name: libvirt-python
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "libvirt-python" --no-build-isolation
        sources:
          - type: file
            url: https://libvirt.org/sources/python/libvirt-python-11.0.0.tar.gz
            sha256: cee825a53c6438c5bc84b4250b35493a8e504d5d8075d3d2069ffaf7090846f8

      - name: python-gobject
        buildsystem: meson
        config-opts:
          - -Dpycairo=enabled
        build-options:
          build-args:
            - --share=network
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/pygobject/-/archive/3.51.0/pygobject-3.51.0.tar
            sha256: 469a26fa572724315d57df3dfc030bd16aea0476ef795537e2851ebdebfab0c5
        modules:
          - name: python-cairo
            buildsystem: meson
            sources:
              - type: archive
                url: https://github.com/pygobject/pycairo/releases/download/v1.27.0/pycairo-1.27.0.tar.gz
                sha256: 5cb21e7a00a2afcafea7f14390235be33497a2cce53a98a19389492a60628430

      - name: gtksourceview5
        buildsystem: meson
        config-opts:
          - -Dvapi=false
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/gtksourceview/-/archive/5.14.0/gtksourceview-5.14.0.tar
            sha256: a6981a77bfb58c4b32d7ed2621875b220f076fcd3154ea11330371775b281a30

      - name: python3-yaml
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pyyaml" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/54/ed/79a089b6be93607fa5cdaedf301d7dfb23af5f25c398d5ead2525b063e17/pyyaml-6.0.2.tar.gz
            sha256: d584d9ec91ad65861cc08d42e834324ef890a082e591037abe114850ff7bbc3e

      - name: python3-jinja2
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "jinja2" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/b2/97/5d42485e71dfc078108a86d6de8fa46db44a1a9295e89c5d6d4a06e23a62/markupsafe-3.0.2.tar.gz
            sha256: ee55d3edf80167e48ea11a923c7386f4669df67d7994554387f84e7d8b0a2bf0
          - type: file
            url: https://files.pythonhosted.org/packages/bd/0f/2ba5fbcd631e3e88689309dbe978c5769e883e4b84ebfe7da30b43275c5a/jinja2-3.1.5-py3-none-any.whl
            sha256: aba0f4dc9ed8013c424088f68a5c226f7d6097ed89b246d7749c2ec4175c6adb
